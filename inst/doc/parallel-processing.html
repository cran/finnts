<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Parallel Processing</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Parallel Processing</h1>



<div id="local-machine" class="section level2">
<h2>Local Machine</h2>
<p>When the “parallel_processing” input within “forecast_time_series” is
set to “local_machine”, each time series (including training models on
the entire data set) is ran in parallel on the users local machine. Each
time series will run on a separate core of the machine. Hyperparameter
tuning, model refitting, and model averaging will be ran sequentially,
which cannot be done in parallel since a parallel process is already
running on the machine for each time series. This works well for data
that contains many time series where you might only want to run a few
simpler models, and in scenarios where cloud computing is not
available.</p>
<p>If “parallel_processing” is set to NULL and “run_model_parallel” is
set to TRUE within the “forecast_time_series” function, then each time
series is ran sequentially but the hyperparameter tuning, model
refitting, and model averaging is ran in parallel. This works great for
data that has a limited number of time series where you want to run a
lot of back testing and build dozens of models within Finn.</p>
</div>
<div id="within-azure-using-spark" class="section level2">
<h2>Within Azure using Spark</h2>
<p>To leverage the full power of Finn, running within Azure is the best
choice in building production ready forecasts that can easily scale. The
most efficient way to run Finn is to set “parallel_processing” to
“spark” within the “forecast_time_series” function. This will run each
time series in parallel across a spark compute cluster.</p>
<p><a href="https://spark.rstudio.com/">Sparklyr</a> is a great R
package that allows you to run R code across a spark cluster. A user
simply has to connect to a spark cluster then run Finn. Below is an
example on how you can run Finn using <a href="https://docs.microsoft.com/en-us/azure/databricks/spark/latest/sparkr/sparklyr">spark
on Azure Databricks</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load CRAN libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(finnts)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sparklyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;qs&quot;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(qs)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># connect to spark cluster</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">sparklyr.log.console =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">sparklyr.spark_apply.serializer =</span> <span class="st">&quot;qs&quot;</span>) <span class="co"># uses the qs package to improve data serialization before sending to spark cluster</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>sc <span class="ot">&lt;-</span> sparklyr<span class="sc">::</span><span class="fu">spark_connect</span>(<span class="at">method =</span> <span class="st">&quot;databricks&quot;</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># call Finn with spark parallel processing</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>hist_data <span class="ot">&lt;-</span> timetk<span class="sc">::</span>m4_monthly <span class="sc">%&gt;%</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Date =</span> date) <span class="sc">%&gt;%</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.character</span>(id))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>finn_output <span class="ot">&lt;-</span> finnts<span class="sc">::</span><span class="fu">forecast_time_series</span>(</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">input_data =</span> hist_data,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">combo_variables =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>),</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_variable =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_type =</span> <span class="st">&quot;month&quot;</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_horizon =</span> <span class="dv">3</span>, </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_processing =</span> <span class="st">&quot;spark&quot;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The above example runs each time series on a separate core on a spark
cluster. You can also submit multiple time series where each time series
runs on a separate spark executor (VM) and then leverage all of the
cores on that executor to run things like hyperparameter tuning or model
refitting in parallel. This creates two levels of parallelization. One
at the time series level, then another when doing things like
hyperparameter tuning within a specific time series. To do that set the
“run_model_parallel” argument to TRUE in the “forecast_time_series”
function. Also make sure that you adjust the number of spark executor
cores to 1, that ensures that only 1 time series runs on an executor at
a time. Leverage the “spark.executor.cores” argument when configuring
your spark connection. This can be done using <a href="https://spark.rstudio.com/guides/connections#:~:text=In%20sparklyr%2C%20Spark%20properties%20can%20be%20set%20by,customized%20as%20shown%20in%20the%20example%20code%20below.">sparklyr</a>
or within the cluster manager itself within the Azure resource. Use the
“num_cores” argument in the “forecast_time_series” function to control
how many cores should be used within an executor when running things
like hyperparameter tuning.</p>
<p>Finn does not leverage spark data frames (yet!), so the input data to
Finn still needs to be a standard data frame or tibble. The
“forecast_time_series” function will be looking for a variable called
“sc” to use when submitting tasks to the spark cluster, so make sure you
use that as the variable name when connecting to spark.</p>
</div>
<div id="within-azure-using-azure-batch" class="section level2">
<h2>Within Azure using Azure Batch</h2>
<p>Important Note: The Azure Batch R packages have been deprecated.
Please leverage the newer Azure compute options with Finn (like
spark).</p>
<p>The second most efficient way to run Finn in Azure is to set
“parallel_processing” to “azure_batch” and set “run_model_parallel” to
“TRUE” within the “forecast_time_series” function. This will run each
time series in separate virtual machines (VM) in Azure Batch. Within
each VM, hyperparameter tuning, modeling refitting, and model averaging
are all done in parallel across the cores available on the machine.</p>
<p><a href="https://azure.microsoft.com/en-us/products/batch/#overview">Azure
Batch</a> is a powerful resource from Microsoft Azure, that allows for
easily salable parallel compute. Finn leverages the <a href="https://github.com/Azure/doAzureParallel">doAzureParallel</a> and
rAzureBatch packages built by Microsoft to connect to Azure batch. Refer
to their <a href="https://github.com/Azure/doAzureParallel">GitHub
site</a> for more information about how it works under the hood and how
to set up your own Azure Batch resource to use with Finn.</p>
<p>In order to have Finn live on CRAN, it cannot contain any package
dependencies that live outside of CRAN. The doAzureParallel and
rAzureBatch packages are only on GitHub, so they will have to be
installed and called outside of Finn.</p>
<p>Reference the example below to understand how to connect to an Azure
Batch compute cluster and submit forecasts to run in the cloud. Make
sure to enter your specific Azure account information.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load CRAN libraries</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(finnts)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># load GitHub libraries</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;Azure/rAzureBatch&quot;</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;Azure/doAzureParallel&quot;</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rAzureBatch)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doAzureParallel)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># create azure batch cluster info</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>azure_batch_credentials <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;sharedKey&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;batchAccount&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name&quot;</span> <span class="ot">=</span> <span class="st">&quot;&lt;insert resource name&gt;&quot;</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;key&quot;</span> <span class="ot">=</span> <span class="st">&quot;&lt;insert compute key&gt;&quot;</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;url&quot;</span> <span class="ot">=</span> <span class="st">&quot;&lt;insert resource URL&gt;&quot;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;storageAccount&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;name&quot;</span> <span class="ot">=</span> <span class="st">&quot;&lt;insert resource name&gt;&quot;</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;key&quot;</span> <span class="ot">=</span> <span class="st">&quot;&lt;insert compute key&gt;&quot;</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;endpointSuffix&quot;</span> <span class="ot">=</span> <span class="st">&quot;core.windows.net&quot;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;githubAuthenticationToken&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;dockerAuthentication&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&quot;username&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;password&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;registry&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>azure_batch_cluster_config <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span> <span class="ot">=</span> <span class="st">&quot;&lt;insert compute cluster name&gt;&quot;</span>,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;vmSize&quot;</span> <span class="ot">=</span> <span class="st">&quot;Standard_D5_v2&quot;</span>, <span class="co"># solid VM size that has worked well in the past with Finn forecasts</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;maxTasksPerNode&quot;</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="co"># tells the cluster to only run one unique time series for each VM. That enables us to then run another layer of parallel processing within the VM</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;poolSize&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;dedicatedNodes&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;min&quot;</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;max&quot;</span> <span class="ot">=</span> <span class="dv">200</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;lowPriorityNodes&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;min&quot;</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;max&quot;</span> <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;autoscaleFormula&quot;</span> <span class="ot">=</span> <span class="st">&quot;QUEUE&quot;</span> <span class="co"># automatically scales up VM&#39;s as more jobs get sent to the cluster. </span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;containerImage&quot;</span> <span class="ot">=</span> <span class="st">&quot;mftokic/finn-azure-batch-dev&quot;</span>, <span class="co"># docker image you can use that automatically downloads software needed for Finn to run in cloud</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;rPackages&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;cran&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;Rcpp&#39;</span>, <span class="st">&#39;modeltime&#39;</span>, <span class="st">&#39;modeltime.resample&#39;</span>, <span class="st">&#39;parsnip&#39;</span>, <span class="st">&#39;tune&#39;</span>, <span class="st">&#39;recipes&#39;</span>, <span class="st">&#39;rsample&#39;</span>, <span class="st">&#39;workflows&#39;</span>, <span class="st">&#39;dials&#39;</span>, <span class="st">&#39;lubridate&#39;</span>, <span class="st">&#39;rules&#39;</span>, <span class="st">&#39;Cubist&#39;</span>, <span class="st">&#39;earth&#39;</span>, <span class="st">&#39;kernlab&#39;</span>, <span class="st">&#39;doParallel&#39;</span>, <span class="st">&#39;dplyr&#39;</span>, <span class="st">&#39;tibble&#39;</span>, <span class="st">&#39;tidyr&#39;</span>, <span class="st">&#39;purrr&#39;</span>, <span class="st">&#39;stringr&#39;</span>, <span class="st">&#39;prophet&#39;</span>, <span class="st">&#39;glmnet&#39;</span>, <span class="st">&#39;gtools&#39;</span>), <span class="co"># finnts package dependencies</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;github&quot;</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bioconductor&quot;</span> <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;commandLine&quot;</span> <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a><span class="co"># create or connect to existing Azure Batch cluster</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>doAzureParallel<span class="sc">::</span><span class="fu">setCredentials</span>(azure_batch_credentials)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>cluster <span class="ot">&lt;-</span> doAzureParallel<span class="sc">::</span><span class="fu">makeCluster</span>(azure_batch_cluster_config)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>doAzureParallel<span class="sc">::</span><span class="fu">registerDoAzureParallel</span>(cluster)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co"># call Finn with Azure Batch parallel processing</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>hist_data <span class="ot">&lt;-</span> timetk<span class="sc">::</span>m4_monthly <span class="sc">%&gt;%</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Date =</span> date) <span class="sc">%&gt;%</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.character</span>(id))</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>finn_output <span class="ot">&lt;-</span> finnts<span class="sc">::</span><span class="fu">forecast_time_series</span>(</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">input_data =</span> hist_data,</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">combo_variables =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>),</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_variable =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_type =</span> <span class="st">&quot;month&quot;</span>,</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_horizon =</span> <span class="dv">3</span>, </span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_processing =</span> <span class="st">&quot;azure_batch&quot;</span>, </span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">run_name =</span> <span class="st">&quot;azure_batch_forecast_test&quot;</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a><span class="co"># optional code to delete compute cluster</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">stopCluster</span>(cluster)</span></code></pre></div>
<p>The best part of Azure Batch is how it can easily scale to more
compute as needed. In the above example, the lowest amount of VM’s
running at any time will be 2, and can easily scale to 300 when needed.
This allows you to pay for extra compute only when you need it, and
allows for forecasts to run that much quicker. You can have separate
Finn forecasts (different data sets or inputs) submitted to the same
Azure Batch cluster to all run in parallel. How cool is that?!</p>
<p>To keep your Azure resource keys secure without hard coding them into
a R script, check out the <a href="https://github.com/Azure/AzureKeyVault">Azure Key Vault</a>
package to safely retrieve and leverage keys/secrets when using
Finn.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
